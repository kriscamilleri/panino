# /docker-compose.dev.yml
version: '3.8'

services:
  # The unified backend service for auth, sync, and images
  api-service:
    build: ./backend/api-service
    ports:
      - "127.0.0.1:8000:8000"
    environment:
      JWT_SECRET: ${JWT_SECRET:-super-secret-for-dev}
      PORT: 8000
      NODE_ENV: development
      # Email settings (e.g., for MailHog or other test SMTP)
      SMTP_HOST: ${SMTP_HOST:-mailhog}
      SMTP_PORT: ${SMTP_PORT:-1025}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}
      SMTP_FROM: ${SMTP_FROM:-"Panino Dev <noreply@panino.dev>"}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:5173}
    volumes:
      - ./backend/api-service:/app
      - ./backend/api-service/data:/app/data # Persist SQLite DBs
      - ./backend/api-service/uploads:/app/uploads # Persist uploaded files
      - /app/node_modules

  # Add MailHog for local email testing
  mailhog:
    image: mailhog/mailhog
    ports:
      - "127.0.0.1:1025:1025" # SMTP
      - "127.0.0.1:8025:8025" # Web UI

  # The font service is a simple proxy, kept separate for clarity
  font-service:
    build: ./backend/font-service
    ports:
      - "127.0.0.1:3002:3002"
    environment:
      PORT: 3002
      NODE_ENV: development
    volumes:
      - ./backend/font-service:/app
      - /app/node_modules

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    ports:
      - "127.0.0.1:5173:5173"
    environment:
      NODE_ENV: development
      VITE_API_SERVICE_URL: http://localhost:8000 # Unified API URL
      VITE_FONT_SERVICE_URL: http://localhost:3002
      VITE_TURNSTILE_SITE_KEY: ${VITE_TURNSTILE_SITE_KEY}
    volumes:
      - ./frontend:/app
      - /app/node_modules
    command: npm run dev -- --host
    depends_on:
      - api-service
      - font-service
      - mailhog